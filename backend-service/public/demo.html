<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiPet Agent Service - æµå¼èŠå¤©æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-section {
            padding: 30px;
        }

        .demo-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .demo-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .demo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .demo-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            text-align: right;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 20px 20px 5px 20px;
            display: inline-block;
            max-width: 70%;
            word-wrap: break-word;
        }

        .agent-message {
            text-align: left;
        }

        .agent-message .message-content {
            background: white;
            padding: 15px 20px;
            border-radius: 20px 20px 20px 5px;
            display: inline-block;
            max-width: 80%;
            word-wrap: break-word;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .agent-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-label .emoji {
            font-size: 1.2em;
        }

        .butler { color: #4facfe; }
        .doctor { color: #ff6b6b; }
        .nutritionist { color: #4ecdc4; }
        .trainer { color: #45b7d1; }
        .faq { color: #96ceb4; }
        .avatar { color: #feca57; }
        .system { color: #a55eea; }

        .transfer-message {
            text-align: center;
            margin: 20px 0;
        }

        .transfer-message .message-content {
            background: linear-gradient(135deg, #a55eea 0%, #8e44ad 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            display: inline-block;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .typing-indicator {
            display: none;
            text-align: left;
            margin-bottom: 20px;
        }

        .typing-indicator .message-content {
            background: white;
            padding: 15px 20px;
            border-radius: 20px 20px 20px 5px;
            display: inline-block;
            border: 1px solid #e9ecef;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .custom-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .custom-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .custom-input input:focus {
            border-color: #667eea;
        }

        .custom-input button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .custom-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .custom-input button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }

        .feature-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .feature-card p {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¾ HiPet Agent Service</h1>
            <p>Intelligent Pet Health Management Platform - LangGraph Workflow Demo</p>
        </div>

        <div class="demo-section">
            <div id="status" class="status info">
                ğŸš€ å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ¼”ç¤º
            </div>

            <div class="demo-controls">
                <button class="demo-btn" onclick="runDemo('health')">ğŸ¥ å¥åº·ç´§æ€¥æƒ…å†µ (éšæœº)</button>
                <button class="demo-btn" onclick="runDemo('nutrition')">ğŸ½ï¸ è¥å…»å’¨è¯¢ (éšæœº)</button>
                <button class="demo-btn" onclick="runDemo('training')">ğŸ¾ è®­ç»ƒå’¨è¯¢ (éšæœº)</button>
                <button class="demo-btn" onclick="runDemo('faq')">â“ FAQå’¨è¯¢ (éšæœº)</button>
                <button class="demo-btn" onclick="runDemo('avatar')">ğŸ¨ å¤´åƒç”Ÿæˆ (éšæœº)</button>
                <button class="demo-btn" onclick="returnToButler()">ğŸ”„ è¿”å›ç®¡å®¶</button>
                <button class="demo-btn" onclick="testRandomOnly()">ğŸ² æµ‹è¯•éšæœº</button>
                <button class="demo-btn" onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©ºèŠå¤©</button>
            </div>
            
            <div style="text-align: center; margin: 10px 0; color: #666; font-size: 14px;">
                ğŸ’¡ Tip: Based on LangGraph workflow, each click will randomly select different questions. Open browser console (F12) to view random selection details
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="message agent-message">
                    <div class="agent-label butler">
                        <span class="emoji">ğŸ¤–</span>
                        AIç®¡å®¶
                    </div>
                    <div class="message-content">
                        æ‚¨å¥½ï¼æˆ‘æ˜¯HiPetçš„AIç®¡å®¶ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å® ç‰©å¥åº·ç®¡ç†å»ºè®®ã€‚è¯·é€‰æ‹©ä¸Šæ–¹çš„æ¼”ç¤ºæ¡ˆä¾‹ï¼Œæˆ–è€…ç›´æ¥è¾“å…¥æ‚¨çš„é—®é¢˜ã€‚
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="agent-label system">
                    <span class="emoji">â³</span>
                    ç³»ç»Ÿ
                </div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>

            <div class="custom-input">
                <input type="text" id="customInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleKeyPress(event)">
                <button onclick="sendCustomMessage()" id="sendBtn">å‘é€</button>
            </div>

            <div class="features">
                <div class="feature-card">
                    <h3>ğŸ¯ æ™ºèƒ½åˆ†æµ</h3>
                    <p>è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œæ™ºèƒ½è½¬æ¥åˆ°åˆé€‚çš„ä¸“ç§‘Agent</p>
                </div>
                <div class="feature-card">
                    <h3>âš¡ LangGraph Workflow</h3>
                    <p>Intelligent workflow based on LangGraph, supporting complex multi-agent collaboration</p>
                </div>
                <div class="feature-card">
                    <h3>ğŸ¥ ä¸“ä¸šå»ºè®®</h3>
                    <p>æ¯ä¸ªAgentéƒ½æä¾›ä¸“ä¸šçº§çš„å® ç‰©å¥åº·å»ºè®®</p>
                </div>
                <div class="feature-card">
                    <h3>ğŸ”„ æ— ç¼è½¬æ¥</h3>
                    <p>ç”¨æˆ·æ— éœ€é‡å¤è¾“å…¥ï¼ŒAIç›´æ¥åŸºäºä¸Šä¸‹æ–‡å›å¤</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "";
        const chatContainer = document.getElementById('chatContainer');
        const typingIndicator = document.getElementById('typingIndicator');
        const status = document.getElementById('status');
        const customInput = document.getElementById('customInput');
        const sendBtn = document.getElementById('sendBtn');

        const demoCases = {
            health: {
                questions: [
                    "æˆ‘çš„ç‹—ç‹—æœ€è¿‘æ€»æ˜¯å‘•åï¼Œæ²¡æœ‰ç²¾ç¥ï¼Œå·²ç»2å¤©äº†ï¼Œè¿˜æ‹‰ç¨€ï¼Œæˆ‘å¾ˆæ‹…å¿ƒ",
                    "æˆ‘çš„ç‹—ç‹—ä»Šå¤©çªç„¶ä¸åƒä¸œè¥¿ï¼Œè¿˜ä¸€ç›´æµå£æ°´ï¼Œçœ‹èµ·æ¥å¾ˆç—›è‹¦",
                    "æˆ‘çš„ç‹—ç‹—èµ°è·¯ä¸€ç˜¸ä¸€æ‹çš„ï¼Œå³åè…¿å¥½åƒä¸æ•¢ç€åœ°ï¼Œæ˜¯ä¸æ˜¯éª¨æŠ˜äº†ï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—å‘¼å¸å¾ˆæ€¥ä¿ƒï¼ŒèˆŒå¤´æœ‰ç‚¹å‘ç´«ï¼Œæ˜¯ä¸æ˜¯å¿ƒè„æœ‰é—®é¢˜ï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—çœ¼ç›çº¢è‚¿ï¼Œä¸€ç›´æµçœ¼æ³ªï¼Œè¿˜ç»å¸¸ç”¨çˆªå­æŒ çœ¼ç›",
                    "My dog has been vomiting and has diarrhea for 2 days, very worried",
                    "My dog suddenly stopped eating and keeps drooling, looks in pain",
                    "My dog is limping and won't put weight on his right hind leg, is it broken?",
                    "My dog is breathing rapidly with a purple tongue, heart problem?",
                    "My dog's eyes are red and swollen, keeps tearing and scratching"
                ],
                name: "å¥åº·ç´§æ€¥æƒ…å†µ / Health Emergency"
            },
            nutrition: {
                questions: [
                    "æˆ‘çš„ç‹—ç‹—ä½“é‡æœ‰ç‚¹è¶…æ ‡ï¼Œç°åœ¨30å…¬æ–¤ï¼Œåº”è¯¥åƒä»€ä¹ˆç‹—ç²®ï¼Ÿéœ€è¦å‡è‚¥å—ï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—æœ€è¿‘æ‰æ¯›å¾ˆä¸¥é‡ï¼Œæ˜¯ä¸æ˜¯è¥å…»ä¸å¤Ÿï¼Ÿéœ€è¦è¡¥å……ä»€ä¹ˆï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—æ˜¯å¹¼çŠ¬ï¼Œ3ä¸ªæœˆå¤§ï¼Œåº”è¯¥æ€ä¹ˆå–‚å…»ï¼Ÿä¸€å¤©å–‚å‡ æ¬¡ï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—å¯¹æŸäº›é£Ÿç‰©è¿‡æ•ï¼Œæ€ä¹ˆçŸ¥é“å“ªäº›é£Ÿç‰©ä¸èƒ½åƒï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—æ˜¯è€å¹´çŠ¬ï¼Œ10å²äº†ï¼Œé¥®é£Ÿä¸Šéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ",
                    "My dog is overweight at 30kg, what food should I feed? Need to diet?",
                    "My dog is shedding heavily, is it nutritional deficiency? What supplements?",
                    "My dog is a puppy, 3 months old, how should I feed? How many times a day?",
                    "My dog has food allergies, how to know which foods to avoid?",
                    "My dog is 10 years old, what should I pay attention to in diet?"
                ],
                name: "è¥å…»å’¨è¯¢ / Nutrition Consultation"
            },
            training: {
                questions: [
                    "æˆ‘çš„ç‹—ç‹—ä¸ä¼šåä¸‹ï¼Œæ€ä¹ˆè®­ç»ƒï¼Ÿå®ƒå¾ˆè°ƒçš®ï¼Œæ³¨æ„åŠ›ä¸é›†ä¸­",
                    "æˆ‘çš„ç‹—ç‹—æ€»æ˜¯ä¹±å«ï¼Œç‰¹åˆ«æ˜¯æœ‰äººç»è¿‡çš„æ—¶å€™ï¼Œæ€ä¹ˆçº æ­£ï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—å–œæ¬¢å’¬ä¸œè¥¿ï¼ŒæŠŠæˆ‘çš„é‹å­éƒ½å’¬åäº†ï¼Œæ€ä¹ˆåŠï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—å‡ºé—¨å°±ä¹±è·‘ï¼Œä¸å¬è¯ï¼Œæ€ä¹ˆè®­ç»ƒå®ƒéšè¡Œï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—å¾ˆèƒ†å°ï¼Œè§åˆ°é™Œç”Ÿäººå°±èº²ï¼Œæ€ä¹ˆè®©å®ƒæ›´è‡ªä¿¡ï¼Ÿ",
                    "My dog doesn't know how to sit, how to train? He's very naughty and distracted",
                    "My dog barks constantly, especially when people pass by, how to stop?",
                    "My dog likes to chew things, ruined my shoes, what to do?",
                    "My dog runs around when outside, doesn't listen, how to train loose leash?",
                    "My dog is very timid, hides from strangers, how to make him confident?"
                ],
                name: "è®­ç»ƒå’¨è¯¢ / Training Consultation"
            },
            faq: {
                questions: [
                    "é¡¹åœˆæ€ä¹ˆæ¸…æ´—ï¼Ÿç”¨æ™®é€šè‚¥çš‚å¯ä»¥å—ï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—é¡¹åœˆæ²¡ç”µäº†ï¼Œæ€ä¹ˆå……ç”µï¼Ÿå……ç”µéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ",
                    "é¡¹åœˆçš„æ•°æ®æ€ä¹ˆçœ‹ï¼Ÿå¿ƒç‡å¤šå°‘ç®—æ­£å¸¸ï¼Ÿ",
                    "æˆ‘çš„ç‹—ç‹—é¡¹åœˆä¸¢äº†ï¼Œèƒ½å®šä½æ‰¾åˆ°å—ï¼Ÿ",
                    "é¡¹åœˆé˜²æ°´å—ï¼Ÿä¸‹é›¨å¤©èƒ½æ­£å¸¸ä½¿ç”¨å—ï¼Ÿ",
                    "How to clean the collar? Can I use regular soap?",
                    "My dog's collar is out of battery, how to charge? How long to charge?",
                    "How to read collar data? What's normal heart rate?",
                    "My dog's collar is lost, can I track and find it?",
                    "Is the collar waterproof? Can it work normally in rain?"
                ],
                name: "FAQå’¨è¯¢ / FAQ Consultation"
            },
            avatar: {
                questions: [
                    "æƒ³è¦å¯çˆ±çš„èµ›åšå¡é€šé£æ ¼å¤´åƒï¼Œè¦çªå‡ºç‹—ç‹—çš„è€³æœµ",
                    "å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªä¸“ä¸šçš„å® ç‰©å¤´åƒï¼Œè¦çœ‹èµ·æ¥å¾ˆå¸…æ°”",
                    "æˆ‘æƒ³è¦ä¸€ä¸ªQç‰ˆé£æ ¼çš„ç‹—ç‹—å¤´åƒï¼Œè¦èŒèŒçš„",
                    "ç”Ÿæˆä¸€ä¸ªå†™å®é£æ ¼çš„å® ç‰©å¤´åƒï¼Œè¦å¾ˆé€¼çœŸ",
                    "æˆ‘æƒ³è¦ä¸€ä¸ªåŠ¨æ¼«é£æ ¼çš„ç‹—ç‹—å¤´åƒï¼Œè¦å¾ˆå¯çˆ±",
                    "Want a cute cyber cartoon style avatar, highlight the dog's ears",
                    "Generate a professional pet avatar, make it look handsome",
                    "I want a chibi style dog avatar, make it super cute",
                    "Generate a realistic style pet avatar, make it very lifelike",
                    "I want an anime style dog avatar, make it adorable"
                ],
                name: "å¤´åƒç”Ÿæˆ / Avatar Generation"
            }
        };

        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function addMessage(content, type, agent = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            let labelHtml = '';
            if (agent) {
                const emoji = getAgentEmoji(agent);
                const className = agent.toLowerCase();
                labelHtml = `<div class="agent-label ${className}">
                    <span class="emoji">${emoji}</span>
                    ${getAgentName(agent)}
                </div>`;
            }
            
            messageDiv.innerHTML = `
                ${labelHtml}
                <div class="message-content">${content}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function getAgentEmoji(agent) {
            const emojis = {
                'butler': 'ğŸ¤–',
                'doctor': 'ğŸ¥',
                'nutritionist': 'ğŸ½ï¸',
                'trainer': 'ğŸ¾',
                'faq': 'â“',
                'avatar': 'ğŸ¨',
                'system': 'âš™ï¸'
            };
            return emojis[agent] || 'ğŸ¤–';
        }

        function getAgentName(agent) {
            const names = {
                'butler': 'AIç®¡å®¶',
                'doctor': 'AIåŒ»ç”Ÿ',
                'nutritionist': 'è¥å…»å¸ˆ',
                'trainer': 'è®­ç»ƒå¸ˆ',
                'faq': 'FAQåŠ©æ‰‹',
                'avatar': 'å¤´åƒè®¾è®¡å¸ˆ',
                'system': 'ç³»ç»Ÿ'
            };
            return names[agent] || 'AIåŠ©æ‰‹';
        }

        function showTyping() {
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        async function runDemo(caseType) {
            const demoCase = demoCases[caseType];
            if (!demoCase) return;

            // ä½¿ç”¨æ›´ç®€å•çš„éšæœºæ•°ç”Ÿæˆ
            const randomIndex = Math.floor(Math.random() * demoCase.questions.length);
            const randomQuestion = demoCase.questions[randomIndex];
            
            // è°ƒè¯•ä¿¡æ¯
            console.log(`[${new Date().toLocaleTimeString()}] é€‰æ‹©é—®é¢˜ ${randomIndex + 1}/${demoCase.questions.length}: ${randomQuestion}`);

            // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
            document.querySelectorAll('.demo-btn').forEach(btn => btn.disabled = true);
            sendBtn.disabled = true;
            
            updateStatus(`æ­£åœ¨æ¼”ç¤º: ${demoCase.name} - éšæœºé—®é¢˜ (${randomIndex + 1}/${demoCase.questions.length})`, 'info');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(randomQuestion, 'user');
            
            // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
            showTyping();
            
            try {
                const response = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: randomQuestion,
                        conversation_summary: "",
                        pet_profile: {
                            name: "å°ç™½",
                            breed: "é‡‘æ¯›",
                            age: 24,
                            weight: 25.5,
                            gender: "male",
                            neutered: true
                        },
                        window_stats: {
                            timestamp: new Date().toISOString(),
                            heart_rate: 125.0,
                            hrv: 40.0,
                            activity_level: 0.2
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                hideTyping();
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            
                            if (data === '[DONE]') {
                                updateStatus('âœ… æ¼”ç¤ºå®Œæˆï¼', 'success');
                                break;
                            }
                            
                            try {
                                const responseData = JSON.parse(data);
                                handleStreamResponse(responseData);
                            } catch (e) {
                                console.error('JSON parse error:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                hideTyping();
                updateStatus(`âŒ æ¼”ç¤ºå¤±è´¥: ${error.message}`, 'error');
                addMessage(`æ¼”ç¤ºå¤±è´¥: ${error.message}`, 'agent', 'system');
            } finally {
                // é‡æ–°å¯ç”¨æŒ‰é’®
                document.querySelectorAll('.demo-btn').forEach(btn => btn.disabled = false);
                sendBtn.disabled = false;
            }
        }

        function handleStreamResponse(responseData) {
            const { type, agent, content } = responseData;
            
            if (type === 'router') {
                const { next, reason, confidence, response_preview } = content;
                addMessage(`
                    <strong>ğŸ¯ ç›®æ ‡:</strong> ${next}<br>
                    <strong>ğŸ’­ åŸå› :</strong> ${reason}<br>
                    <strong>ğŸ“Š ç½®ä¿¡åº¦:</strong> ${confidence}<br>
                    <strong>ğŸ’¬ é¢„è§ˆ:</strong> ${response_preview}
                `, 'agent', 'butler');
                
            } else if (type === 'transfer') {
                addMessage(content.message, 'transfer');
                
            } else if (type === 'specialist') {
                let message = '';
                
                if (agent === 'doctor') {
                    const { assessment, risk_level, watchouts, next_actions, when_to_see_vet } = content;
                    message = `
                        <strong>ğŸ¥ è¯„ä¼°:</strong> ${assessment}<br><br>
                        <strong>âš ï¸ é£é™©ç­‰çº§:</strong> ${risk_level.toUpperCase()}<br><br>
                        <strong>ğŸ‘€ è§‚å¯Ÿè¦ç‚¹:</strong><br>
                        ${watchouts.slice(0, 3).map((w, i) => `${i + 1}. ${w}`).join('<br>')}<br><br>
                        <strong>ğŸ“‹ å»ºè®®è¡ŒåŠ¨:</strong><br>
                        ${next_actions.slice(0, 3).map((a, i) => `${i + 1}. ${a}`).join('<br>')}<br><br>
                        <strong>ğŸš¨ å°±åŒ»æ—¶æœº:</strong> ${when_to_see_vet}
                    `;
                } else if (agent === 'nutritionist') {
                    const { summary, meal_plan, avoid_list, tips } = content;
                    message = `
                        <strong>ğŸ½ï¸ æ€»ç»“:</strong> ${summary}<br><br>
                        <strong>ğŸ“ é¥®é£Ÿè®¡åˆ’:</strong><br>
                        ${meal_plan.slice(0, 3).map((p, i) => `${i + 1}. ${p}`).join('<br>')}<br><br>
                        <strong>ğŸš« é¿å…é£Ÿç‰©:</strong><br>
                        ${avoid_list.slice(0, 3).map((a, i) => `${i + 1}. ${a}`).join('<br>')}<br><br>
                        <strong>ğŸ’¡ å°è´´å£«:</strong><br>
                        ${tips.slice(0, 3).map((t, i) => `${i + 1}. ${t}`).join('<br>')}
                    `;
                } else if (agent === 'faq') {
                    const { answer, source } = content;
                    message = `
                        <strong>â“ ç­”æ¡ˆ:</strong> ${answer}<br><br>
                        <strong>ğŸ“š æ¥æº:</strong> ${source === 'builtin' ? 'å†…ç½®çŸ¥è¯†åº“' : 'é€šç”¨å›ç­”'}
                    `;
                } else if (agent === 'trainer') {
                    const { plan, exercise, env_setup, warnings } = content;
                    message = `
                        <strong>ğŸ¾ è®­ç»ƒè®¡åˆ’:</strong><br>
                        ${plan.slice(0, 3).map((p, i) => `${i + 1}. ${p}`).join('<br>')}<br><br>
                        <strong>ğŸƒ è¿åŠ¨å»ºè®®:</strong><br>
                        ${exercise.slice(0, 3).map((e, i) => `${i + 1}. ${e}`).join('<br>')}<br><br>
                        <strong>âš ï¸ æ³¨æ„äº‹é¡¹:</strong><br>
                        ${warnings.slice(0, 3).map((w, i) => `${i + 1}. ${w}`).join('<br>')}
                    `;
                } else if (agent === 'avatar') {
                    const { style, quality, notes, ok_to_generate } = content;
                    message = `
                        <strong>ğŸ¨ é£æ ¼:</strong> ${style}<br><br>
                        <strong>ğŸ“ è´¨é‡:</strong> ${quality}<br><br>
                        <strong>ğŸ“ å¤‡æ³¨:</strong> ${notes}<br><br>
                        <strong>âœ… å¯ç”Ÿæˆ:</strong> ${ok_to_generate ? 'æ˜¯' : 'å¦'}
                    `;
                } else if (agent === 'butler' && content.status === 'returned_to_butler') {
                    // å¤„ç†è¿”å›ç®¡å®¶çš„ç‰¹æ®Šå“åº”
                    message = content.message;
                } else {
                    message = JSON.stringify(content, null, 2);
                }
                
                addMessage(message, 'agent', agent);
            }
        }

        async function sendCustomMessage() {
            const message = customInput.value.trim();
            if (!message) return;
            
            customInput.value = '';
            sendBtn.disabled = true;
            
            addMessage(message, 'user');
            showTyping();
            
            try {
                const response = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_summary: "",
                        pet_profile: {
                            name: "å°ç™½",
                            breed: "é‡‘æ¯›",
                            age: 24,
                            weight: 25.5,
                            gender: "male",
                            neutered: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                hideTyping();
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            
                            if (data === '[DONE]') {
                                updateStatus('âœ… å›å¤å®Œæˆï¼', 'success');
                                break;
                            }
                            
                            try {
                                const responseData = JSON.parse(data);
                                handleStreamResponse(responseData);
                            } catch (e) {
                                console.error('JSON parse error:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                hideTyping();
                updateStatus(`âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
                addMessage(`å‘é€å¤±è´¥: ${error.message}`, 'agent', 'system');
            } finally {
                sendBtn.disabled = false;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendCustomMessage();
            }
        }

        function clearChat() {
            chatContainer.innerHTML = `
                <div class="message agent-message">
                    <div class="agent-label butler">
                        <span class="emoji">ğŸ¤–</span>
                        AIç®¡å®¶
                    </div>
                    <div class="message-content">
                        èŠå¤©è®°å½•å·²æ¸…ç©ºï¼Œè¯·é€‰æ‹©æ¼”ç¤ºæ¡ˆä¾‹æˆ–è¾“å…¥æ–°é—®é¢˜ã€‚
                    </div>
                </div>
            `;
            updateStatus('ğŸ—‘ï¸ èŠå¤©è®°å½•å·²æ¸…ç©º', 'info');
        }

        function testRandomOnly() {
            // æµ‹è¯•FAQçš„éšæœºé€‰æ‹©
            const faqCase = demoCases.faq;
            const results = [];
            
            for (let i = 0; i < 10; i++) {
                const randomIndex = Math.floor(Math.random() * faqCase.questions.length);
                results.push(randomIndex + 1);
            }
            
            console.log('FAQéšæœºæµ‹è¯•ç»“æœ:', results);
            addMessage(`ğŸ² éšæœºæµ‹è¯•ç»“æœ: ${results.join(', ')} (åº”è¯¥çœ‹åˆ°ä¸åŒçš„æ•°å­—)`, 'agent', 'system');
            updateStatus('ğŸ² éšæœºæµ‹è¯•å®Œæˆï¼ŒæŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…', 'info');
        }

        async function returnToButler() {
            const message = "æˆ‘æƒ³å›åˆ°ç®¡å®¶ï¼Œæˆ–è€…æ¢ä¸ªä¸“ç§‘å’¨è¯¢";
            addMessage(message, 'user');
            showTyping();
            
            try {
                const response = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_summary: "ç”¨æˆ·æƒ³è¦è¿”å›ç®¡å®¶æˆ–æ¢ä¸“ç§‘å’¨è¯¢",
                        pet_profile: {
                            name: "å°ç™½",
                            breed: "é‡‘æ¯›",
                            age: 24,
                            weight: 25.5,
                            gender: "male",
                            neutered: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                hideTyping();
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            
                            if (data === '[DONE]') {
                                updateStatus('ğŸ”„ å·²è¿”å›ç®¡å®¶ï¼Œå¯ä»¥ç»§ç»­å’¨è¯¢', 'success');
                                break;
                            }
                            
                            try {
                                const responseData = JSON.parse(data);
                                handleStreamResponse(responseData);
                            } catch (e) {
                                console.error('JSON parse error:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                hideTyping();
                updateStatus(`âŒ è¿”å›ç®¡å®¶å¤±è´¥: ${error.message}`, 'error');
                addMessage(`è¿”å›ç®¡å®¶å¤±è´¥: ${error.message}`, 'agent', 'system');
            }
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServiceStatus() {
            try {
                const response = await fetch(`${API_BASE}/health/`);
                if (response.ok) {
                    updateStatus('âœ… æœåŠ¡è¿è¡Œæ­£å¸¸ï¼Œå¯ä»¥å¼€å§‹æ¼”ç¤º', 'success');
                } else {
                    updateStatus('âŒ æœåŠ¡çŠ¶æ€å¼‚å¸¸', 'error');
                }
            } catch (error) {
                updateStatus('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡ï¼Œè¯·ç¡®ä¿ agent-service æ­£åœ¨è¿è¡Œ', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
        window.addEventListener('load', checkServiceStatus);
    </script>
</body>
</html>
