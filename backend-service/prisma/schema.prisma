generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  passwordHash  String?
  firstName     String?
  lastName      String?
  phone         String?        @unique
  avatarUrl     String?
  emailVerified Boolean        @default(false)
  phoneVerified Boolean        @default(false)
  isActive      Boolean        @default(true)
  lastLoginAt   DateTime?
  preferences   Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  oauthAccounts OAuthAccount[]
  pets          Pet[]
  sessions      UserSession[]
}

model Pet {
  id             String          @id @default(cuid())
  name           String
  species        String?
  breed          String?
  birthDate      DateTime?
  weight         Float?
  gender         String?
  avatarUrl      String?
  healthNotes    String?
  ownerId        String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deviceBindings DeviceBinding[]
  healthAlerts   HealthAlert[]
  healthData     HealthData[]
  sensorAnalyses SensorAnalysis[]
  owner          User            @relation(fields: [ownerId], references: [id])
}

model HealthData {
  id          String   @id @default(cuid())
  petId       String
  heartRate   Float?
  temperature Float?
  activity    Float?
  timestamp   DateTime @default(now())
  anomaly     Boolean  @default(false)
  pet         Pet      @relation(fields: [petId], references: [id])
}

model ChatMessage {
  id          String   @id @default(cuid())
  userId      String
  petId       String
  sessionId   String?
  messageType String
  content     Json
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([sessionId, createdAt])
}

model ChatSession {
  id         String    @id @default(cuid())
  userId     String
  petId      String
  status     String    @default("active")
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  title      String?
  summary    Json?
  transcript Json?
  meta       Json?
  updatedAt  DateTime  @updatedAt
}

model UserSession {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  lastUsedAt DateTime @default(now())
  userAgent  String?
  ipAddress  String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OAuthAccount {
  id           String    @id @default(cuid())
  userId       String
  provider     String
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  scope        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
}

model EmailVerification {
  id        String   @id @default(cuid())
  userId    String
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Device {
  id                 String              @id @default(cuid())
  deviceId           String              @unique
  deviceType         String
  model              String?
  firmwareVersion    String?
  hardwareVersion    String?
  manufactureDate    DateTime?
  status             String              @default("inactive")
  lastOnlineAt       DateTime?
  lastSyncAt         DateTime?
  batteryLevel       Int?
  signalStrength     Int?
  deviceToken        String?             @unique // Long-term token for device authentication
  deviceTokenExpiresAt DateTime?         // Optional expiration for device token
  metadata           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  bindings           DeviceBinding[]
  events             DeviceEvent[]
  healthAlerts       HealthAlert[]
  sensorDataSessions SensorDataSession[]
  sensorAnalyses     SensorAnalysis[]

  @@index([deviceId])
  @@index([status])
  @@index([deviceToken])
}

model DeviceBinding {
  id            String    @id @default(cuid())
  deviceId      String
  petId         String
  userId        String
  bindingCode   String?
  status        String    @default("active")
  isPrimary     Boolean   @default(true)
  bindingType   String    @default("owner")
  startDate     DateTime  @default(now())
  endDate       DateTime?
  unboundAt     DateTime?
  unboundBy     String?
  unboundReason String?
  permissions   Json?
  settings      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  device        Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  pet           Pet       @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@unique([deviceId, petId, status])
  @@index([deviceId])
  @@index([petId])
  @@index([userId])
  @@index([status])
}

model DeviceEvent {
  id         String    @id @default(cuid())
  deviceId   String
  eventType  String
  severity   String    @default("info")
  message    String?
  data       Json?
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime  @default(now())
  device     Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId, createdAt])
  @@index([eventType])
  @@index([severity])
}

model SensorDataSession {
  id                  String             @id @default(cuid())
  sessionId           String             @unique
  deviceId            String
  timestamp           DateTime
  firmwareVersion     String?
  dataIntervalSeconds Int?
  uploadReason        String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  behaviorAnalysis    BehaviorAnalysis?
  healthAlerts        HealthAlert[]
  healthAssessment    HealthAssessment?
  mediaAnalysis       MediaAnalysis?
  motionSamples       MotionSample[]
  device              Device             @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  summaryStatistics   SummaryStatistics?
  systemStatus        SystemStatus?
  vitalSignsSamples   VitalSignsSample[]
  sensorAnalyses      SensorAnalysis[]
  analysisJobs        AnalysisJob[]

  @@index([deviceId, timestamp])
  @@index([sessionId])
  @@index([timestamp])
}

model VitalSignsSample {
  id              String            @id @default(cuid())
  sessionId       String
  timestampOffset Int
  temperatureC    Float?
  heartRateBpm    Int?
  createdAt       DateTime          @default(now())
  session         SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestampOffset])
}

model MotionSample {
  id                String            @id @default(cuid())
  sessionId         String
  timestampOffset   Int
  accelerationX     Float?
  accelerationY     Float?
  accelerationZ     Float?
  movementIntensity Float?
  createdAt         DateTime          @default(now())
  session           SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestampOffset])
}

model HealthAssessment {
  id                    String            @id @default(cuid())
  sessionId             String            @unique
  overallHealthScore    Int?
  vitalSignsStability   Int?
  trendAnalysis         String?
  createdAt             DateTime          @default(now())
  abnormalitiesDetected String[]
  session               SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model BehaviorAnalysis {
  id                      String            @id @default(cuid())
  sessionId               String            @unique
  activityLevel           Int?
  moodState               Int?
  behaviorPattern         String?
  unusualBehaviorDetected Boolean           @default(false)
  createdAt               DateTime          @default(now())
  session                 SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model MediaAnalysis {
  id          String            @id @default(cuid())
  sessionId   String            @unique
  createdAt   DateTime          @default(now())
  audioEvents AudioEvent[]
  session     SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  videoEvents VideoEvent[]

  @@index([sessionId])
}

model AudioEvent {
  id              String        @id @default(cuid())
  mediaAnalysisId String
  timestampOffset Int
  eventType       String?
  durationMs      Int?
  emotionalTone   String?
  createdAt       DateTime      @default(now())
  mediaAnalysis   MediaAnalysis @relation(fields: [mediaAnalysisId], references: [id], onDelete: Cascade)

  @@index([mediaAnalysisId, timestampOffset])
}

model VideoEvent {
  id                 String        @id @default(cuid())
  mediaAnalysisId    String
  timestampOffset    Int
  movementType       String?
  environmentChanges String?
  createdAt          DateTime      @default(now())
  mediaAnalysis      MediaAnalysis @relation(fields: [mediaAnalysisId], references: [id], onDelete: Cascade)

  @@index([mediaAnalysisId, timestampOffset])
}

model SummaryStatistics {
  id              String            @id @default(cuid())
  sessionId       String            @unique
  temperatureMean Float?
  temperatureMin  Float?
  temperatureMax  Float?
  heartRateMean   Float?
  heartRateMin    Int?
  heartRateMax    Int?
  createdAt       DateTime          @default(now())
  session         SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model SystemStatus {
  id                 String            @id @default(cuid())
  sessionId          String            @unique
  batteryLevel       Int?
  memoryUsagePercent Int?
  storageAvailableMb Int?
  createdAt          DateTime          @default(now())
  session            SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// ============ AI Analysis Results ============
model SensorAnalysis {
  id          String   @id @default(cuid())
  sessionId   String
  deviceId    String
  petId       String?
  metrics     Json
  metricsMeta Json?
  insights    Json
  confidence  Float
  model       String?
  options     Json?
  createdAt   DateTime @default(now())

  session     SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  device      Device            @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  pet         Pet?              @relation(fields: [petId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([deviceId])
  @@index([petId])
  @@index([createdAt])
}

model AnalysisJob {
  id         String   @id @default(cuid())
  sessionId  String
  status     String   @default("enqueued")
  attempts   Int      @default(0)
  lastError  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  session    SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([status])
}

model HealthAlert {
  id         String            @id @default(cuid())
  sessionId  String
  petId      String?
  deviceId   String
  alertType  String
  severity   String            @default("warning")
  message    String
  data       Json?
  isRead     Boolean           @default(false)
  isResolved Boolean           @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime          @default(now())
  device     Device            @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  pet        Pet?              @relation(fields: [petId], references: [id], onDelete: Cascade)
  session    SensorDataSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([deviceId, createdAt])
  @@index([petId, createdAt])
  @@index([alertType])
  @@index([severity])
  @@index([isRead, isResolved])
}
